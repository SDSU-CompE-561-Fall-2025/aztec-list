openapi: 3.0.3
info:
  title: Aztec List API
  version: "0.1.0"
  description: |
    OfferUp-style marketplace for college students. JWT-secured API with listings,
    images, user profiles, and admin moderation (warnings/strikes/bans/listing removal).

servers:
  - url: https://api.example.com
    description: Production
  - url: http://localhost:8000
    description: Local dev

tags:
  - name: Listings
  - name: Images
  - name: Users
  - name: Profiles
  - name: Auth
  - name: Admin

paths:
  /api/listings:
    get:
      tags: [Listings]
      summary: List active listings with filters and cursor pagination
      parameters:
        - $ref: '#/components/parameters/q'
        - $ref: '#/components/parameters/category'
        - $ref: '#/components/parameters/min_price'
        - $ref: '#/components/parameters/max_price'
        - $ref: '#/components/parameters/condition'
        - $ref: '#/components/parameters/seller_id'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
        - $ref: '#/components/parameters/sort'
      responses:
        '200':
          description: Paginated listings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListingsPage'
        '400': { $ref: '#/components/responses/BadRequest' }
        '500': { $ref: '#/components/responses/ServerError' }
    post:
      tags: [Listings]
      summary: Create a new listing
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateListingRequest'
      responses:
        '201':
          description: Created listing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Listing'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }

  /api/listings/{listing_id}:
    get:
      tags: [Listings]
      summary: Get listing by ID
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      responses:
        '200':
          description: Listing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Listing'
        '404': { $ref: '#/components/responses/NotFound' }
    patch:
      tags: [Listings]
      summary: Update listing (owner only)
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateListingRequest'
      responses:
        '200':
          description: Updated listing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Listing'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
    delete:
      tags: [Listings]
      summary: Delete listing (owner or admin)
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      responses:
        '204':
          description: Deleted (no content)
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/users/{user_id}/listings:
    get:
      tags: [Listings]
      summary: List a specific user's listings
      parameters:
        - $ref: '#/components/parameters/user_id'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
        - $ref: '#/components/parameters/sort'
        - $ref: '#/components/parameters/include_inactive'
      responses:
        '200':
          description: Paginated user listings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListingsPage'
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/ServerError' }

  /api/users/{user_id}:
    get:
      tags: [Users]
      summary: Get a user's public profile
      parameters: [ { $ref: '#/components/parameters/user_id' } ]
      responses:
        '200':
          description: Public user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublicWithStats'
        '404': { $ref: '#/components/responses/NotFound' }

  /api/listings/{listing_id}/images:
    post:
      tags: [Images]
      summary: Upload images for a listing
      description: Owner or admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [files]
              properties:
                files:
                  type: array
                  minItems: 1
                  maxItems: 10
                  items:
                    type: string
                    format: binary
                set_as_thumbnail:
                  type: boolean
                  default: false
                alt_text:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Uploaded images and current thumbnail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageUploadResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/listings/{listing_id}/images/{image_id}:
    delete:
      tags: [Images]
      summary: Delete a specific image from a listing
      security: [{ bearerAuth: [] }]
      parameters:
        - { $ref: '#/components/parameters/listing_id' }
        - { $ref: '#/components/parameters/image_id' }
      responses:
        '204': { description: Deleted }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/listings/{listing_id}/images/thumbnail:
    patch:
      tags: [Images]
      summary: Set listing thumbnail
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [image_id]
              properties:
                image_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Thumbnail updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListingThumbnailResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/users/profile:
    post:
      tags: [Profiles]
      summary: Create a profile for the authenticated user
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProfileRequest'
      responses:
        '201':
          description: Created profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
    get:
      tags: [Profiles]
      summary: Get the authenticated user's profile
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/include_listings'
      responses:
        '200':
          description: Profile (optionally with listings)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileWithListings'
        '401': { $ref: '#/components/responses/Unauthorized' }
    patch:
      tags: [Profiles]
      summary: Update the authenticated user's profile
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/users/profile/picture:
    post:
      tags: [Profiles]
      summary: Upload/replace profile picture
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Profile picture uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id: { type: string, format: uuid }
                  profile_picture_url: { type: string, format: uri }
                  updated_at: { type: string, format: date-time }
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '415':
          description: Unsupported Media Type
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /api/auth/signup:
    post:
      tags: [Auth]
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SignupRequest' }
      responses:
        '201':
          description: Created user (safe fields only)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SignupResponse' }
        '400': { $ref: '#/components/responses/BadRequest' }
        '422': { $ref: '#/components/responses/Unprocessable' }

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Authenticate and obtain a JWT access token
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        '200':
          description: Auth token and basic user info
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LoginResponse' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '422': { $ref: '#/components/responses/Unprocessable' }

  /api/admin/actions:
    post:
      tags: [Admin]
      summary: Create a moderation action
      description: Admin only.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateAdminActionRequest' }
      responses:
        '201':
          description: Created admin action
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminAction' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
    get:
      tags: [Admin]
      summary: List moderation actions (cursor-paginated)
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters:
        - $ref: '#/components/parameters/target_user_id'
        - $ref: '#/components/parameters/admin_id'
        - $ref: '#/components/parameters/action_type'
        - $ref: '#/components/parameters/target_listing_id'
        - $ref: '#/components/parameters/from'
        - $ref: '#/components/parameters/to'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/cursor'
      responses:
        '200':
          description: Paginated admin actions
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminActionPage' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }

  /api/admin/actions/{action_id}:
    get:
      tags: [Admin]
      summary: Get a specific admin action
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/action_id' } ]
      responses:
        '200':
          description: Admin action
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminAction' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }
    delete:
      tags: [Admin]
      summary: Revoke an admin action
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/action_id' } ]
      responses:
        '204': { description: Revoked }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/admin/users/{user_id}/warning:
    post:
      tags: [Admin]
      summary: Issue a warning (convenience wrapper)
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/user_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason: { type: string }
      responses:
        '201':
          description: Warning created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminAction' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/admin/users/{user_id}/strike:
    post:
      tags: [Admin]
      summary: Add a strike (convenience wrapper)
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/user_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason: { type: string }
      responses:
        '201':
          description: Strike created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminAction' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/admin/users/{user_id}/ban:
    post:
      tags: [Admin]
      summary: Ban a user (temporary or permanent)
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/user_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason: { type: string }
                expires_at:
                  type: string
                  format: date-time
                  nullable: true
      responses:
        '201':
          description: Ban created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AdminAction' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/admin/listings/{listing_id}/remove:
    post:
      tags: [Admin]
      summary: Remove a listing and log the action
      description: Admin only.
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason: { type: string }
      responses:
        '200':
          description: Listing removed and action recorded
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ListingRemovalResponse' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/admin/listings/{listing_id}/restore:
    post:
      tags: [Admin]
      summary: Restore a previously removed listing
      description: Admin only (if soft deletes are implemented).
      security: [{ bearerAuth: [] }]
      parameters: [ { $ref: '#/components/parameters/listing_id' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason: { type: string }
      responses:
        '200':
          description: Restored listing status
          content:
            application/json:
              schema:
                type: object
                properties:
                  listing_id: { type: string, format: uuid }
                  status: { type: string, enum: [restored] }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '404': { $ref: '#/components/responses/NotFound' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    listing_id:
      name: listing_id
      in: path
      required: true
      schema: { type: string, format: uuid }
    image_id:
      name: image_id
      in: path
      required: true
      schema: { type: string, format: uuid }
    user_id:
      name: user_id
      in: path
      required: true
      schema: { type: string, format: uuid }
    action_id:
      name: action_id
      in: path
      required: true
      schema: { type: string, format: uuid }

    q:
      name: q
      in: query
      description: Full-text search over title/description
      schema: { type: string }
    category:
      name: category
      in: query
      schema: { type: string }
    min_price:
      name: min_price
      in: query
      schema: { type: number, format: float, minimum: 0 }
    max_price:
      name: max_price
      in: query
      schema: { type: number, format: float, minimum: 0 }
    condition:
      name: condition
      in: query
      schema: { $ref: '#/components/schemas/ConditionEnum' }
    seller_id:
      name: seller_id
      in: query
      schema: { type: string, format: uuid }
    limit:
      name: limit
      in: query
      schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
    cursor:
      name: cursor
      in: query
      schema: { type: string, nullable: true }
    sort:
      name: sort
      in: query
      schema: { $ref: '#/components/schemas/SortEnum' }
    include_inactive:
      name: include_inactive
      in: query
      schema: { type: boolean, default: false }
    include_listings:
      name: include_listings
      in: query
      schema: { type: boolean, default: false }

    target_user_id:
      name: target_user_id
      in: query
      schema: { type: string, format: uuid }
    admin_id:
      name: admin_id
      in: query
      schema: { type: string, format: uuid }
    target_listing_id:
      name: target_listing_id
      in: query
      schema: { type: string, format: uuid }
    action_type:
      name: action_type
      in: query
      schema: { $ref: '#/components/schemas/ActionTypeEnum' }
    from:
      name: from
      in: query
      description: Filter actions created at/after this time
      schema: { type: string, format: date-time }
    to:
      name: to
      in: query
      description: Filter actions created before this time
      schema: { type: string, format: date-time }

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    Unauthorized:
      description: Authentication required or invalid token
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    Forbidden:
      description: Not allowed (ownership/admin policy)
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    Unprocessable:
      description: Validation error
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }
    ServerError:
      description: Unexpected server error
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  schemas:
    # Enums
    ConditionEnum:
      type: string
      enum: [new, like_new, good, fair]
    SortEnum:
      type: string
      enum: [recent, price_asc, price_desc]
    ActionTypeEnum:
      type: string
      enum: [warning, strike, ban, listing_removal]

    # Core models
    UserPublic:
      type: object
      properties:
        id: { type: string, format: uuid }
        username: { type: string }
        email: { type: string, format: email }
        created_at: { type: string, format: date-time }
        is_verified: { type: boolean }
    UserPublicWithStats:
      allOf:
        - $ref: '#/components/schemas/UserPublic'
        - type: object
          properties:
            joined_at: { type: string, format: date-time }
            listings_count: { type: integer }
    Profile:
      type: object
      properties:
        id: { type: string, format: uuid }
        user_id: { type: string, format: uuid }
        name: { type: string }
        campus: { type: string, nullable: true }
        contact_info:
          type: object
          additionalProperties: true
          nullable: true
        profile_picture_url: { type: string, format: uri, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time, nullable: true }
    ProfileWithListings:
      allOf:
        - $ref: '#/components/schemas/Profile'
        - type: object
          properties:
            listings:
              type: array
              items: { $ref: '#/components/schemas/ListingCard' }
              nullable: true
    Listing:
      type: object
      properties:
        id: { type: string, format: uuid }
        seller_id: { type: string, format: uuid }
        title: { type: string }
        description: { type: string }
        price: { type: number, format: float, minimum: 0 }
        category: { type: string }
        condition: { $ref: '#/components/schemas/ConditionEnum' }
        thumbnail_url: { type: string, format: uri, nullable: true }
        is_active: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time, nullable: true }
        images:
          type: array
          items: { $ref: '#/components/schemas/Image' }
          nullable: true
    ListingCard:
      type: object
      properties:
        id: { type: string, format: uuid }
        title: { type: string }
        price: { type: number, format: float }
        category: { type: string }
        condition: { $ref: '#/components/schemas/ConditionEnum' }
        thumbnail_url: { type: string, format: uri, nullable: true }
        created_at: { type: string, format: date-time }
        is_active: { type: boolean, nullable: true }
        seller_id: { type: string, format: uuid, nullable: true }
    Image:
      type: object
      properties:
        id: { type: string, format: uuid }
        listing_id: { type: string, format: uuid }
        url: { type: string, format: uri }
        is_thumbnail: { type: boolean }
        alt_text: { type: string, nullable: true }
        created_at: { type: string, format: date-time }

    AdminAction:
      type: object
      properties:
        id: { type: string, format: uuid }
        admin_id: { type: string, format: uuid }
        target_user_id: { type: string, format: uuid }
        target_listing_id: { type: string, format: uuid, nullable: true }
        action_type: { $ref: '#/components/schemas/ActionTypeEnum' }
        reason: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
        expires_at: { type: string, format: date-time, nullable: true }

    # Request/response wrappers
    ListingsPage:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/ListingCard' }
        next_cursor: { type: string, nullable: true }
        count: { type: integer }
    UserListingsPage:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/ListingCard' }
        next_cursor: { type: string, nullable: true }
        count: { type: integer }

    ImageUploadResponse:
      type: object
      properties:
        listing_id: { type: string, format: uuid }
        thumbnail_url: { type: string, format: uri, nullable: true }
        images:
          type: array
          items: { $ref: '#/components/schemas/Image' }

    ListingThumbnailResponse:
      type: object
      properties:
        listing_id: { type: string, format: uuid }
        thumbnail_url: { type: string, format: uri, nullable: true }
        updated_at: { type: string, format: date-time }

    SignupRequest:
      type: object
      required: [username, email, password]
      properties:
        username: { type: string }
        email: { type: string, format: email }
        password: { type: string, format: password }
    SignupResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        username: { type: string }
        email: { type: string, format: email }
        created_at: { type: string, format: date-time }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password }
    LoginResponse:
      type: object
      properties:
        access_token: { type: string }
        token_type: { type: string, enum: [bearer] }
        user: { $ref: '#/components/schemas/UserPublic' }

    CreateListingRequest:
      type: object
      required: [title, description, price, category, condition]
      properties:
        title: { type: string }
        description: { type: string }
        price: { type: number, format: float, minimum: 0 }
        category: { type: string }
        condition: { $ref: '#/components/schemas/ConditionEnum' }
    UpdateListingRequest:
      type: object
      properties:
        title: { type: string }
        description: { type: string }
        price: { type: number, format: float, minimum: 0 }
        category: { type: string }
        condition: { $ref: '#/components/schemas/ConditionEnum' }
        is_active: { type: boolean }

    CreateProfileRequest:
      type: object
      required: [name]
      properties:
        name: { type: string }
        campus: { type: string, nullable: true }
        contact_info:
          type: object
          additionalProperties: true
          nullable: true
    UpdateProfileRequest:
      type: object
      properties:
        name: { type: string }
        campus: { type: string }
        contact_info:
          type: object
          additionalProperties: true

    CreateAdminActionRequest:
      type: object
      required: [target_user_id, action_type]
      properties:
        target_user_id: { type: string, format: uuid }
        action_type: { $ref: '#/components/schemas/ActionTypeEnum' }
        reason: { type: string, nullable: true }
        expires_at: { type: string, format: date-time, nullable: true }
        target_listing_id: { type: string, format: uuid, nullable: true }

    AdminActionPage:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/AdminAction' }
        next_cursor: { type: string, nullable: true }
        count: { type: integer }

    ListingRemovalResponse:
      type: object
      properties:
        listing_id: { type: string, format: uuid }
        status: { type: string, enum: [removed] }
        admin_action: { $ref: '#/components/schemas/AdminAction' }

    Error:
      type: object
      properties:
        detail: { type: string }
        request_id: { type: string, format: uuid, nullable: true }
